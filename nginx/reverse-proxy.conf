# Servidor para a página inicial (homeserver)
server {
    listen 80;
    server_name homeserver;

    root /var/www/html;
    index index.html;
}

# Proxy para o Pi-hole (pihole.homeserver)
server {
    listen 80;
    server_name pihole.homeserver;

    location / {
        # O nome 'pihole' é resolvido pelo DNS interno do Docker para o IP do container do Pi-hole
        proxy_pass http://pihole:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Proxy para o Home Assistant (ha.homeserver)
server {
    listen 80;
    server_name ha.homeserver;

    location / {
        proxy_pass http://homeassistant:8123;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Headers necessários para o funcionamento do WebSocket (essencial para o Home Assistant)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# Proxy para o Komodo (komodo.homeserver)
# NOTA: A porta do Komodo no seu healthcheck é 9120. Estou usando essa porta.
server {
    listen 80;
    server_name komodo.homeserver;

    location / {
        proxy_pass http://komodo-core:9120;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Headers para WebSocket, úteis para interfaces web modernas
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# Proxy para o Webmin (webmin.homeserver) - serviço fora do Docker
server {
    listen 80;
    server_name webmin.homeserver;

    location / {
        # 'host.docker.internal' é um DNS especial que resolve para o IP da máquina host
        # a partir de dentro de um container Docker.
        proxy_pass http://localhost:10000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
